##
# Pull in LTO settings. NTHREADS must be first line, follows by sourcing the config. No exceptions, always first.
# During the LTO step, we default the parallelism to the number of processors, as detected by the compiler.
##
NTHREADS="auto"
LTO_OVERLAY_PATH="/var/db/repos/lto-overlay"
source make.conf.lto

##
# Ninja's a bit faster than GNU Make, so this might speed things up very slightly.
##
CMAKE_MAKEFILE_GENERATOR=ninja

##
# Don't change the CFLAGS.
##

# odin: x86-64-v4
# ymir: x86-64-v4
# bragi: x86-64-v3
# aegir: x86-64-v3
#
# So therefore, build for x86-64-v3
CFLAGS="${CFLAGS} -march=x86-64-v3 -mtune=generic"
CXXFLAGS="${CFLAGS} ${CXXFLAGS}"
LDFLAGS="${LDFLAGS}"

##
# You can touch these, but you probably don't want or need to.
##
PORTAGE_LOGDIR=/var/log/portage/
PORTAGE_COMPRESS=zstd
PORTAGE_COMPRESS_FLAGS=-15
PORTAGE_NICENESS=20

BINPKG_FORMAT=gpkg
BINPKG_COMPRESS=zstd
BINPKG_COMPRESS_FLAGS=-15

FEATURES="${FEATURES} buildpkg binpkg-multi-instance clean-logs compress-build-logs parallel-fetch parallel-install split-elog split-log userfetch usersync"
FEATURES="${FEATURES} compressdebug installsources splitdebug"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --jobs --keep-going --newrepo --newuse --changed-use --changed-deps --changed-slot --deep --tree --unordered-display --backtrack=3000 --complete-graph --with-bdeps=y"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --rebuild-if-new-rev --rebuild-if-new-ver --rebuild-if-unbuilt --rebuilt-binaries"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --binpkg-respect-use=y --binpkg-changed-deps=y --usepkg=y"

# Don't bother making binpkgs for packages that wont benefit from it. The time spent compressing would just be wasted.
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --buildpkg-exclude='virtual/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --buildpkg-exclude='sys-kernel/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --buildpkg-exclude='*/*-bin'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --buildpkg-exclude='acct-user/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --buildpkg-exclude='acct-group/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --buildpkg-exclude='app-alternatives/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --buildpkg-exclude='dev-perl/*'"

# Don't bother insalling binpkgs packages that wont benefit from it. Even if they are available, the decompression would be just a waste of time
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg-exclude='virtual/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg-exclude='sys-kernel/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg-exclude='*/*-bin'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg-exclude='acct-user/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg-exclude='acct-group/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg-exclude='app-alternatives/*'"
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --usepkg-exclude='dev-perl/*'"

##
# Use these to configure what features your programs are built with.
##
INPUT_DEVICES="libinput"
LINGUAS="en en_US"
L10N="en en-US"
QEMU_USER_TARGETS="aarch64 x86_64"
QEMU_SOFTMMU_TARGETS="aarch64 x86_64"

# Raspberry pi, x86_64
LLVM_TARGETS="AArch64 AMDGPU BPF WebAssembly X86"

##
# Default to only supporting 64bit.
# Some select packages have 32bit enabled individually.
##
ABI_X86="64"

##
# Some packages have per-cpu-instruction use flags that portage uses for conditional compilation or dependencies.
# We can't simply say "We have x86-64_v3" apparently.
#
# See https://en.wikipedia.org/wiki/X86-64#Microarchitecture_levels for enumeration
##

# All owned machines have x86-64-v1
CPU_FLAGS_X86="${CPU_FLAGS_X86} cmov cx8 fpu fxsr mmx osfxsr sce sse sse2"

# And x86-64-v2
CPU_FLAGS_X86="${CPU_FLAGS_X86} cmpxchg16b lahf_lm popcnt sse3 sse4_1 sse4_2 ssse3"

# And x86-64-v3
CPU_FLAGS_X86="${CPU_FLAGS_X86} avx avx2 bmi1 bmi2 f16c fma lzcnt movbe osxsave"

# The generic fma instruction family from x86-64-v3 is actually fma3 on intel and amd, and *also* fma4 on amd.
# But apparently intel has no plans to support fma4, and amd has stopped advertising it, so we'll stick with fma3.
# See https://en.wikipedia.org/wiki/FMA_instruction_set
CPU_FLAGS_X86="${CPU_FLAGS_X86} fma3"

# And other flags that `cpuid2cpuflags` says are supported, but which aren't in the wikipedia page.
CPU_FLAGS_X86="${CPU_FLAGS_X86} aes mmxext pclmul rdrand"

##
# Remove files that aren't relevant to systemd systems
##
INSTALL_MASK="${INSTALL_MASK} /etc/init.d/*"
INSTALL_MASK="${INSTALL_MASK} /etc/cron.*/*"
INSTALL_MASK="${INSTALL_MASK} /etc/runlevels//*"

##
# Remove documentation files that no one ever looks at
##
INSTALL_MASK="${INSTALL_MASK} /usr/share/doc/*/"

##
# Remove .desktop files that add unnecessary items to the desktop menu.
##
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/htop.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/xterm.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/uxterm.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/elementary_perf.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/elementary_test.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/spicy-spice-gtk.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/linguist6-qttools-6.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/assistant6-qttools-6.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/qdbusviewer6-qttools-6.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/applications/org.gnome.Vte.App.Gtk3.desktop"
INSTALL_MASK="${INSTALL_MASK} /usr/share/xdg-terminals/org.gnome.Vte.App.Gtk3.desktop"

##
# Don't include files that are excluded above into binpkgs
##
PKG_INSTALL_MASK="${PKG_INSTALL_MASK} {INSTALL_MASK}"

##
# Video cards to support for graphical apps
##
VIDEO_CARDS="vesa modesetting radeon radeonsi amdgpu intel"
